# 12.21.1 Window Function Descriptions

**mysql8.0官方手册**

MySQL supports window functions that, for each row from a query, perform a calculation using rows related to that row.

这里介绍的是非聚合的窗口函数，聚合的窗口函数的描述见[ Section 12.20.1, “Aggregate Function Descriptions”](https://dev.mysql.com/doc/refman/8.0/en/aggregate-functions.html)

**窗口函数总览：**

Name | Description
---|:---
CUME_DIST() | Cumulative distribution value
DENSE_RANK() | Rank of current row within its partition, without gaps
FIRST_VALUE() | Value of argument from first row of window frame
LAG() | Value of argument from row lagging current row within partition
LAST_VALUE() | Value of argument from last row of window frame
LEAD() | Value of argument from row leading current row within partition
NTH_VALUE() | Value of argument from N-th row of window frame
NTILE() | Bucket number of current row within its partition.
PERCENT_RANK() | Percentage rank value
RANK() | Rank of current row within its partition, with gaps
ROW_NUMBER() | Number of current row within its partition

*In the following function descriptions, over_clause represents the OVER clause, described in [Section 12.21.2, “Window Function Concepts and Syntax”](https://dev.mysql.com/doc/refman/8.0/en/window-functions-usage.html). Some window functions permit a null_treatment clause that specifies how to handle NULL values when calculating results. This clause is optional. It is part of the SQL standard, but the MySQL implementation permits only RESPECT NULLS (which is also the default). This means that NULL values are considered when calculating results. IGNORE NULLS is parsed, but produces an error.*

一些窗口函数允许 null_treatment 子句，它指明了在计算结果时，如何处理 NULL 值。这个子句是可选的。

它是 SQL 标准的一部分，但 MYSQL 只遵守这个规则(也是默认情况)。这就意味着在计算结果时，NULL 值会被考虑到。 解析 IGNORE NULLS 会产生错误。

> CUME_DIST() over_clause

返回一个值在一组值中的累积分布。即，**分区字段中，小于或等于当前行的值的百分比**。

它表示在排序后的分区中，当前行之前或与当前行同级的行数除以分区中的总行数。

返回值的范围从0到1。

*Returns the cumulative distribution of a value within a group of values; that is, the percentage of partition values less than or equal to the value in the current row. This represents the number of rows preceding or peer with the current row in the window ordering of the window partition divided by the total number of rows in the window partition. Return values range from 0 to 1.*

*This function should be used with ORDER BY to sort partition rows into the desired order. Without ORDER BY, all rows are peers and have value N/N = 1, where N is the partition size.*

*over_clause is as described in Section 12.21.2, “Window Function Concepts and Syntax”.*

*The following query shows, for the set of values in the val column, the CUME_DIST() value for each row, as well as the percentage rank value returned by the similar PERCENT_RANK() function. For reference, the query also displays row numbers using ROW_NUMBER():*

这个函数应当和 ORDER BY 一起使用，来排序分区中的数据。如果没有 ORDER BY ，所有行都是同级的，N/N = 1，这里的 N 是分区的大小。

```sql
--建表
mysql> CREATE TABLE CUME_DIST_TEST (dept STRING,userid string,sal INT);
ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'STRING,userid string,sal INT)' at line 1
mysql> CREATE TABLE IF NOT EXISTS CUME_DIST_TEST (
    -> dept VARCHAR(100) NOT NULL,
    -> userid VARCHAR(100) NOT NULL,
    -> sal INT);
Query OK, 0 rows affected (0.03 sec)

--插入数据
mysql> INSERT INTO CUME_DIST_TEST VALUES('d1','user1',1000);
Query OK, 1 row affected (0.01 sec)

mysql> INSERT INTO CUME_DIST_TEST VALUES('d1','user2',2000);
Query OK, 1 row affected (0.00 sec)

mysql> INSERT INTO CUME_DIST_TEST VALUES('d1','user3',3000);
Query OK, 1 row affected (0.01 sec)

mysql> INSERT INTO CUME_DIST_TEST VALUES('d2','user4',4000);
Query OK, 1 row affected (0.01 sec)

mysql> INSERT INTO CUME_DIST_TEST VALUES('d2','user1',5000);
Query OK, 1 row affected (0.00 sec)

--统计小于等于当前薪水的人数，所占总人数的比例
mysql> SELECT 
    -> dept,
    -> userid,
    -> sal,
    -> CUME_DIST() OVER(ORDER BY sal) AS rn1,
    -> CUME_DIST() OVER(PARTITION BY dept ORDER BY sal) AS rn2 
    -> FROM CUME_DIST_TEST;
+------+--------+------+-----+--------------------+
| dept | userid | sal  | rn1 | rn2                |
+------+--------+------+-----+--------------------+
| d1   | user1  | 1000 | 0.2 | 0.3333333333333333 |
| d1   | user2  | 2000 | 0.4 | 0.6666666666666666 |
| d1   | user3  | 3000 | 0.6 |                  1 |
| d2   | user4  | 4000 | 0.8 |                0.5 |
| d2   | user1  | 5000 |   1 |                  1 |
+------+--------+------+-----+--------------------+
5 rows in set (0.01 sec)
```

[参考](http://lxw1234.com/archives/2015/04/185.htm)

```sql
mysql> SELECT
         val,
         ROW_NUMBER()   OVER w AS 'row_number',
         CUME_DIST()    OVER w AS 'cume_dist',
         PERCENT_RANK() OVER w AS 'percent_rank'
       FROM numbers
       WINDOW w AS (ORDER BY val);
+------+------------+--------------------+--------------+
| val  | row_number | cume_dist          | percent_rank |
+------+------------+--------------------+--------------+
|    1 |          1 | 0.2222222222222222 |            0 |
|    1 |          2 | 0.2222222222222222 |            0 |
|    2 |          3 | 0.3333333333333333 |         0.25 |
|    3 |          4 | 0.6666666666666666 |        0.375 |
|    3 |          5 | 0.6666666666666666 |        0.375 |
|    3 |          6 | 0.6666666666666666 |        0.375 |
|    4 |          7 | 0.8888888888888888 |         0.75 |
|    4 |          8 | 0.8888888888888888 |         0.75 |
|    5 |          9 |                  1 |            1 |
+------+------------+--------------------+--------------+
```

> DENSE_RANK() over_clause

Returns the rank of the current row within its partition, without gaps. Peers are considered ties and receive the same rank. This function assigns consecutive ranks to peer groups; the result is that groups of size greater than one do not produce noncontiguous rank numbers. For an example, see the RANK() function description.

This function should be used with ORDER BY to sort partition rows into the desired order. Without ORDER BY, all rows are peers.

over_clause is as described in Section 12.21.2, “Window Function Concepts and Syntax”.