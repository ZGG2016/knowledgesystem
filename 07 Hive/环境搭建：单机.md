# 安装hive

前提：安装hadoop、mysql

## 1、配置 MySQL

```sql
-- 创建 hive 数据库 
mysql> CREATE DATABASE hive; 

-- 创建 hive 用户，并赋予访问 hive 数据库的权限 
-- zgg为主机名
mysql> GRANT ALL PRIVILEGES ON hive.* TO 'hive'@'zgg' IDENTIFIED BY 'hive';
mysql> FLUSH PRIVILEGES; 

-- 设置 binary log 的格式： 
mysql> set global binlog_format=MIXED;

```

## 2、下载配置环境变量

配置Hive环境

	vi /etc/profile

添加如下内容：
	
	export HIVE_HOME=/opt/hive-1.2.2
	export PATH=$PATH:$HIVE_HOME/bin

然后
	
	source /etc/profile

然后配置Hive用于Hadoop环境中

	cd /usr/local/hive/conf
	cp hive-env.sh.template hive-env.sh
	vi hive-env.sh

添加如下内容：
	
	export HADOOP_HOME=/opt/hadoop-2.7.3
	export HIVE_CONF_DIR=/opt/hive-1.2.2/conf
	export HIVE_AUX_JARS_PATH=/opt/hive-1.2.2/lib

## 3、修改配置文件hive-site.xml

```xml
<property> 
	<name>hive.server2.thrift.bind.host</name> 
	<value>zgg</value>   //主机名 
</property>
<property> 
	<name>javax.jdo.option.ConnectionURL</name> 
	<value>jdbc:mysql://zgg:3306/hive?createDatabaseIfNotExist=true</value> 
	<description>JDBC connect string for a JDBC metastore</description> 
</property>
<property> 
	<name>javax.jdo.option.ConnectionDriverName</name>
	<value>com.mysql.jdbc.Driver</value> 
	<description>Driver class name for a JDBC metastore</description> 
</property>
<property> 
	<name>javax.jdo.option.ConnectionUserName</name> 
	<value>hive</value> 
	<description>username to use against metastore database</description> 
</property> 
	<property> 
	<name>javax.jdo.option.ConnectionPassword</name> 
	<value>hive</value>
	<description>password to use against metastore database</description> 
</property>
```

<value>jdbc:mysql://zgg:3306/hive?useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;failOverReadOnly=false&amp;allowMultiQueries=true&amp;serverTimezone=UTC&amp;useSSL=false&amp;rewriteBatchedStatements=true</value>



在`/usr/local/hive/bin`目录下新建目录/iotmp

将hive-site.xml中含有 `system:java.io.tmpdir` 的配置项的值修改 `/usr/local/hive/bin/iotmp`


## 4、下载 mysql jdbc jar 包

```sh
wget http://cdn.mysql.com//Downloads/Connector-J/mysql-connector-java-5.1.37.tar.gz 

tar xvzf mysql-connector-java-5.1.37.tar.gz 

cp mysql-connector-java-5.1.37/mysql-connector-java-5.1.37-bin.jar $HIVE_HOME/lib
```

## 6、启动

```sh
[root@zgg hadoop-2.7.3]# sbin/start-all.sh

[root@zgg bin]# hive
```

## 7、问题

(1)启动时，出现：`Caused by: java.sql.SQLException: Access denied for user 'hive'@'zgg' (using password: YES)`

解决：执行：`GRANT ALL PRIVILEGES ON hive.* TO 'hive'@'zgg' IDENTIFIED BY 'hive';`

(2)启动时，出现：`ls: 无法访问/opt/spark-2.4.4-bin-hadoop2.7/lib/spark-assembly-*.jar: 没有那个文件或目录`


原因： spark升级到spark2以后，原有lib目录下的大jar包被分散成多个小jar包，原来的`spark-assembly-*.jar`已经不存在，所以hive没有办法找到这个jar包。简单来讲：新版本的spark,hive没有及时支持更新。

解决方法：修改hive的启动脚本

```
# add Spark assembly jar to the classpath
if [[ -n "$SPARK_HOME" ]]
then
  sparkAssemblyPath=`ls ${SPARK_HOME}/lib/spark-assembly-*.jar`
  CLASSPATH="${CLASSPATH}:${sparkAssemblyPath}"
fi
```

```
# add Spark assembly jar to the classpath
if [[ -n "$SPARK_HOME" ]]
then
  sparkAssemblyPath=`ls ${SPARK_HOME}/jars/*.jar
  CLASSPATH="${CLASSPATH}:${sparkAssemblyPath}"
fi
```

(3)mysql升级到8.0.21后，启动hive，报错`MySQLNonTransientConnectionException: Could not create connection to database serve`

需要hive-site.xml中的mysql配置，更新其版本。

```xml
<property> 
	<name>hive.server2.thrift.bind.host</name> 
	<value>zgg</value>   //主机名 
</property>
<property> 
	<name>javax.jdo.option.ConnectionURL</name> 
	<value>jdbc:mysql://zgg:3306/hive?useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;failOverReadOnly=false&amp;allowMultiQueries=true&amp;serverTimezone=UTC&amp;useSSL=false&amp;rewriteBatchedStatements=true</value> 
	<description>JDBC connect string for a JDBC metastore</description> 
</property>
<property> 
	<name>javax.jdo.option.ConnectionDriverName</name>
	<value>com.mysql.cj.jdbc.Driver</value> 
	<description>Driver class name for a JDBC metastore</description> 
</property>
<property> 
	<name>javax.jdo.option.ConnectionUserName</name> 
	<value>hive</value> 
	<description>username to use against metastore database</description> 
</property> 
	<property> 
	<name>javax.jdo.option.ConnectionPassword</name> 
	<value>hive</value>
	<description>password to use against metastore database</description> 
</property>
```

如果出现`The specified datastore driver ("com.mysql.cj.jdbc.Driver") was not found in...`，说明libs目录下的jar包也要更新。

如果没有在mysql中创建hive用户需要先创建。

```sql
mysql> CREATE DATABASE hive;
Query OK, 1 row affected (0.01 sec)

mysql> CREATE USER 'hive'@'zgg' IDENTIFIED BY 'hive';
Query OK, 0 rows affected (0.01 sec)

mysql> grant all privileges on *.* to 'hive'@'zgg' with grant option;         
Query OK, 0 rows affected (0.02 sec)
```